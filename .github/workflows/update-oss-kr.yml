name: Update kr.txt on OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发

jobs:
  update-oss-file:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤 1: 检出你的仓库代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 步骤 2: 验证目标文件是否存在
      - name: Verify kr.txt exists
        run: |
          if [ -f "./kr.txt" ]; then
            echo "✅ kr.txt 文件存在，文件内容如下："
            cat ./kr.txt
          else
            echo "❌ 错误：仓库根目录下未找到 kr.txt 文件"
            echo "当前工作目录文件列表："
            ls -la
            exit 1
          fi

      # 步骤 3: 通过官方脚本安装ossutil (推荐方案)
      - name: Install ossutil via official script
        run: |
          echo "开始通过官方脚本安装 ossutil..."
          # 此脚本会自动下载并安装最新可用的ossutil版本[citation:8]
          sudo -v ; curl https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash
          echo "✅ 官方脚本执行完毕"

      # 步骤 4: 验证ossutil安装
      - name: Verify ossutil installation
        run: |
          echo "检查ossutil是否可用..."
          ossutil --version
          echo "✅ ossutil 安装验证成功"

      # 步骤 5: 上传文件到OSS
      - name: Upload kr.txt to OSS
        run: |
          echo "开始上传 kr.txt 到 OSS..."
          # 使用 -f 选项强制覆盖OSS上的同名文件[citation:5]
          ossutil cp ./kr.txt oss://kortv/kr.txt -f \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "✅ 文件上传命令执行完成"

      # 步骤 6: (可选) 验证上传结果
      - name: Verify upload success
        run: |
          echo "验证文件是否已成功上传至OSS..."
          ossutil stat oss://kortv/kr.txt \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "🎉 kr.txt 文件已成功上传至阿里云 OSS！"

      # 步骤 7: 任务完成总结
      - name: Upload completion summary
        run: |
          echo "=========================================="
          echo "🚀 OSS 文件同步任务已完成！"
          echo "📦 Bucket: kortv"
          echo "📄 文件: kr.txt"
          echo "📍 Endpoint: oss-cn-hangzhou.aliyuncs.com"
          echo "⏰ 完成时间: $(date)"
          echo "=========================================="
