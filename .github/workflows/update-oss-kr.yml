name: Update kr.txt on OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-oss-file:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: éªŒè¯ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Verify kr.txt exists
        run: |
          if [ -f "./kr.txt" ]; then
            echo "âœ… kr.txt æ–‡ä»¶å­˜åœ¨ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
            cat ./kr.txt
          else
            echo "âŒ é”™è¯¯ï¼šä»“åº“æ ¹ç›®å½•ä¸‹æœªæ‰¾åˆ° kr.txt æ–‡ä»¶"
            echo "å½“å‰å·¥ä½œç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la
            exit 1
          fi

      # æ­¥éª¤ 3: é€šè¿‡å®˜æ–¹è„šæœ¬å®‰è£…ossutil (æ¨èæ–¹æ¡ˆ)
      - name: Install ossutil via official script
        run: |
          echo "å¼€å§‹é€šè¿‡å®˜æ–¹è„šæœ¬å®‰è£… ossutil..."
          # æ­¤è„šæœ¬ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…æœ€æ–°å¯ç”¨çš„ossutilç‰ˆæœ¬[citation:8]
          sudo -v ; curl https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash
          echo "âœ… å®˜æ–¹è„šæœ¬æ‰§è¡Œå®Œæ¯•"

      # æ­¥éª¤ 4: éªŒè¯ossutilå®‰è£…
      - name: Verify ossutil installation
        run: |
          echo "æ£€æŸ¥ossutilæ˜¯å¦å¯ç”¨..."
          ossutil --version
          echo "âœ… ossutil å®‰è£…éªŒè¯æˆåŠŸ"

      # æ­¥éª¤ 5: ä¸Šä¼ æ–‡ä»¶åˆ°OSS
      - name: Upload kr.txt to OSS
        run: |
          echo "å¼€å§‹ä¸Šä¼  kr.txt åˆ° OSS..."
          # ä½¿ç”¨ -f é€‰é¡¹å¼ºåˆ¶è¦†ç›–OSSä¸Šçš„åŒåæ–‡ä»¶[citation:5]
          ossutil cp ./kr.txt oss://kortv/kr.txt -f \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å‘½ä»¤æ‰§è¡Œå®Œæˆ"

      # æ­¥éª¤ 6: (å¯é€‰) éªŒè¯ä¸Šä¼ ç»“æœ
      - name: Verify upload success
        run: |
          echo "éªŒè¯æ–‡ä»¶æ˜¯å¦å·²æˆåŠŸä¸Šä¼ è‡³OSS..."
          ossutil stat oss://kortv/kr.txt \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "ğŸ‰ kr.txt æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ è‡³é˜¿é‡Œäº‘ OSSï¼"

      # æ­¥éª¤ 7: ä»»åŠ¡å®Œæˆæ€»ç»“
      - name: Upload completion summary
        run: |
          echo "=========================================="
          echo "ğŸš€ OSS æ–‡ä»¶åŒæ­¥ä»»åŠ¡å·²å®Œæˆï¼"
          echo "ğŸ“¦ Bucket: kortv"
          echo "ğŸ“„ æ–‡ä»¶: kr.txt"
          echo "ğŸ“ Endpoint: oss-cn-hangzhou.aliyuncs.com"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "=========================================="
