name: Update kr.txt on OSS

on:
  # 触发条件1：当代码推送到 main 分支时自动运行
  push:
    branches: [ main ]
  # 触发条件2：允许在 GitHub 页面上手动触发工作流
  workflow_dispatch:

jobs:
  update-oss-file:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出仓库代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 步骤2：验证 kr.txt 文件是否存在
      - name: Verify kr.txt exists
        run: |
          if [ -f "./kr.txt" ]; then
            echo "✅ kr.txt 文件存在，内容如下："
            cat ./kr.txt
          else
            echo "❌ 错误：kr.txt 文件不存在！"
            echo "当前目录文件列表："
            ls -la
            exit 1
          fi

      # 步骤3：下载并安装 ossutil
      - name: Download and install ossutil
        run: |
         sudo -v ; curl https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash

      # 步骤4：上传 kr.txt 文件到 OSS
      - name: Upload kr.txt to OSS
        run: |
          ./ossutil64 cp ./kr.txt oss://kortv/kr.txt -f \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      # 步骤5：验证上传结果
      - name: Verify upload success
        run: |
          echo "验证文件是否上传成功..."
          ./ossutil64 stat oss://kortv/kr.txt \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "✅ kr.txt 文件已成功上传到阿里云 OSS！"
