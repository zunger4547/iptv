name: Update kr.txt on OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:
    workflows: ["Update Korea Links"]  # ç›‘å¬æŒ‡å®šå·¥ä½œæµ
    types:
      - completed  # å½“å·¥ä½œæµå®Œæˆæ—¶è§¦å‘
    branches: [main]

jobs:
  update-oss-file:
    runs-on: ubuntu-latest
    # ç®€åŒ–æ¡ä»¶ï¼šå…è®¸æ‰€æœ‰è§¦å‘æ–¹å¼ï¼Œä½†å¯¹workflow_runæ·»åŠ é¢å¤–æ¡ä»¶
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      # æ­¥éª¤ 1: ç­‰å¾…1åˆ†é’Ÿå»¶è¿Ÿï¼ˆä»…åœ¨workflow_runè§¦å‘æ—¶ç­‰å¾…ï¼‰
      - name: Wait for 1 minute on workflow_run
        if: github.event_name == 'workflow_run'
        run: sleep 60
        shell: bash

      # æ­¥éª¤ 2: æ£€å‡ºä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository code
        uses: actions/checkout@v4

      # æ­¥éª¤ 3: éªŒè¯ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Verify kr.txt exists
        run: |
          if [ -f "./kr.txt" ]; then
            echo "âœ… kr.txt æ–‡ä»¶å­˜åœ¨ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
            cat ./kr.txt
          else
            echo "âŒ é”™è¯¯ï¼šä»“åº“æ ¹ç›®å½•ä¸‹æœªæ‰¾åˆ° kr.txt æ–‡ä»¶"
            echo "å½“å‰å·¥ä½œç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la
            exit 1
          fi

      # æ­¥éª¤ 4: é€šè¿‡å®˜æ–¹è„šæœ¬å®‰è£…ossutil
      - name: Install ossutil via official script
        run: |
          echo "å¼€å§‹é€šè¿‡å®˜æ–¹è„šæœ¬å®‰è£… ossutil..."
          sudo -v ; curl https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash
          echo "âœ… å®˜æ–¹è„šæœ¬æ‰§è¡Œå®Œæ¯•"

      # æ­¥éª¤ 5: éªŒè¯ossutilå®‰è£…
      - name: Verify ossutil installation
        run: |
          echo "æ£€æŸ¥ossutilæ˜¯å¦å¯ç”¨..."
          ossutil --version
          echo "âœ… ossutil å®‰è£…éªŒè¯æˆåŠŸ"

      # æ­¥éª¤ 6: ä¸Šä¼ æ–‡ä»¶åˆ°OSS
      - name: Upload kr.txt to OSS
        run: |
          echo "å¼€å§‹ä¸Šä¼  kr.txt åˆ° OSS..."
          ossutil cp ./kr.txt oss://kortv/kr.txt -f \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å‘½ä»¤æ‰§è¡Œå®Œæˆ"

      # æ­¥éª¤ 7: éªŒè¯ä¸Šä¼ ç»“æœ
      - name: Verify upload success
        run: |
          echo "éªŒè¯æ–‡ä»¶æ˜¯å¦å·²æˆåŠŸä¸Šä¼ è‡³OSS..."
          ossutil stat oss://kortv/kr.txt \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          echo "ğŸ‰ kr.txt æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ è‡³é˜¿é‡Œäº‘ OSSï¼"

      # æ­¥éª¤ 8: ä»»åŠ¡å®Œæˆæ€»ç»“
      - name: Upload completion summary
        run: |
          echo "=========================================="
          echo "ğŸš€ OSS æ–‡ä»¶åŒæ­¥ä»»åŠ¡å·²å®Œæˆï¼"
          echo "ğŸ“¦ Bucket: kortv"
          echo "ğŸ“„ æ–‡ä»¶: kr.txt"
          echo "ğŸ“ Endpoint: oss-cn-hangzhou.aliyuncs.com"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ”— è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "=========================================="
