name: Update kr.txt on OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  update-oss-file:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²è®°å½•

      # æ­¥éª¤2ï¼šéªŒè¯ kr.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Verify kr.txt exists
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          
          if [ -f "./kr.txt" ]; then
            echo "âœ… kr.txt æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            head -n 10 ./kr.txt
            echo "æ–‡ä»¶å¤§å°: $(wc -l < ./kr.txt) è¡Œ"
          else
            echo "âŒ é”™è¯¯ï¼škr.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "è¯·ç¡®ä¿ kr.txt æ–‡ä»¶ä½äºä»“åº“æ ¹ç›®å½•"
            exit 1
          fi

      # æ­¥éª¤3ï¼šå®‰è£…å¿…è¦çš„å·¥å…·
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          echo "âœ… å¿…è¦å·¥å…·å®‰è£…å®Œæˆ"

      # æ­¥éª¤4ï¼šä¸‹è½½å¹¶é…ç½® ossutil
      - name: Download and setup ossutil
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
          rm -rf ossutil* ossutil-v*
          
          echo "æ­£åœ¨ä¸‹è½½ ossutil..."
          # ä¸‹è½½ ossutil 2.x ç‰ˆæœ¬ï¼ˆæ›´ç¨³å®šï¼‰
          wget "https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-v2.1.2-linux-amd64.zip" -O ossutil.zip
          
          echo "æ­£åœ¨è§£å‹..."
          unzip -q ossutil.zip
          
          echo "è®¾ç½®æ‰§è¡Œæƒé™..."
          # é‡å‘½åä»¥ä¾¿ç»Ÿä¸€ä½¿ç”¨
          cp ossutil-v2.1.2-linux-amd64/ossutil ./ossutil64
          chmod +x ./ossutil64
          
          echo "éªŒè¯å®‰è£…..."
          ./ossutil64 --version
          
          echo "âœ… ossutil å®‰è£…å®Œæˆ"

      # æ­¥éª¤5ï¼šéªŒè¯ OSS è¿æ¥
      - name: Verify OSS connection
        run: |
          echo "æµ‹è¯• OSS è¿æ¥..."
          ./ossutil64 ls oss://kortv \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }} || echo "âš ï¸  Bucket å¯èƒ½ä¸ºç©ºæˆ–æƒé™å—é™ï¼Œä½†è¿æ¥æ­£å¸¸"
          echo "âœ… OSS è¿æ¥æµ‹è¯•å®Œæˆ"

      # æ­¥éª¤6ï¼šä¸Šä¼  kr.txt æ–‡ä»¶åˆ° OSS
      - name: Upload kr.txt to OSS
        run: |
          echo "å¼€å§‹ä¸Šä¼  kr.txt æ–‡ä»¶åˆ° OSS..."
          echo "æºæ–‡ä»¶: ./kr.txt"
          echo "ç›®æ ‡ä½ç½®: oss://kortv/kr.txt"
          echo "Endpoint: oss-cn-hangzhou.aliyuncs.com"
          
          # ä½¿ç”¨ ossutil ä¸Šä¼ æ–‡ä»¶ï¼Œ-f å‚æ•°å¼ºåˆ¶è¦†ç›–
          ./ossutil64 cp ./kr.txt oss://kortv/kr.txt -f \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å‘½ä»¤æ‰§è¡Œå®Œæˆ"

      # æ­¥éª¤7ï¼šéªŒè¯ä¸Šä¼ ç»“æœ
      - name: Verify upload success
        run: |
          echo "éªŒè¯æ–‡ä»¶ä¸Šä¼ ç»“æœ..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº OSS
          echo "æ£€æŸ¥ OSS ä¸­çš„æ–‡ä»¶çŠ¶æ€:"
          ./ossutil64 stat oss://kortv/kr.txt \
            -e oss-cn-hangzhou.aliyuncs.com \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          
          echo "ğŸ‰ kr.txt æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSSï¼"

      # æ­¥éª¤8ï¼šä¸Šä¼ å®Œæˆæ€»ç»“
      - name: Upload completion summary
        run: |
          echo "========================================"
          echo "ğŸš€ OSS æ–‡ä»¶åŒæ­¥ä»»åŠ¡å®Œæˆï¼"
          echo "========================================"
          echo "ğŸ“¦ Bucket: kortv"
          echo "ğŸ“„ æ–‡ä»¶: kr.txt"
          echo "ğŸ“ Endpoint: oss-cn-hangzhou.aliyuncs.com"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ”— å·¥ä½œæµè¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================"
